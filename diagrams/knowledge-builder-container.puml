@startuml
' Container diagram for AdvanDEB Knowledge Builder (Updated with Authentication)

!pragma layout smetana
scale max 1920 width

actor "Users\n(All Roles)" as Users

node "AdvanDEB Knowledge Builder" as KB {
  node "Frontend (Vue 3 + Element Plus)" as KB_FE {
    package "Views" {
      [Home View]
      [KnowledgeBase View]
      [DataProcessing View]
      [Visualization View]
      [Agents View]
      [Ingestion View]
    }
    
    package "Auth Views (New)" {
      [Login View]
      [Profile View]
      [Role Request View]
      [Admin Dashboard]
      [Review Queue]
      [API Key Management]
    }
    
    package "State Management" {
      [Auth Store]
      [api.js + interceptors]
    }
  }

  node "Backend (FastAPI)" as KB_BE {
    package "Auth Layer (New)" {
      [auth.py router]
      [AuthService]
      [GoogleOAuthClient]
      [JWTManager]
      [APIKeyValidator]
      [PermissionChecker]
    }
    
    package "Middleware (New)" {
      [AuthMiddleware]
      [RateLimiter]
      [AuditLogger]
    }

    package "Routers" {
      [knowledge.py]
      [agents.py]
      [data_processing.py]
      [visualization.py]
      [ingestion.py]
      [users.py (New)]
      [role_requests.py (New)]
      [api_keys.py (New)]
      [reviews.py (New)]
    }

    package "Services" {
      [KnowledgeService]
      [AgentService]
      [DataProcessingService]
      [VisualizationService]
      [AgentFramework]
      [LocalModelClient]
      [ToolRegistry]
      [UserService (New)]
      [RoleService (New)]
      [ReviewService (New)]
      [AuditService (New)]
    }

    package "Models" {
      [Knowledge Models]
      [Agent Models]
      [Ingestion Models]
      [User Models (New)]
      [Auth Models (New)]
    }

    package "Database" {
      [Mongo Client (Motor)]
      [Collections: facts, stylized_facts,\ngraphs, documents, agent_sessions,\nusers, role_requests, api_keys,\naudit_logs, contributions]
    }
  }
}

cloud "Google OAuth 2.0" as GoogleAuth
database "MongoDB" as Mongo
node "Ollama LLM Host" as Ollama
database "Redis\n(Rate Limiting +\nCelery)" as Redis

' User to frontend
Users --> KB_FE : Use web UI\n(OAuth login)

' Frontend to Google
KB_FE --> GoogleAuth : OAuth flow

' Frontend to backend
KB_FE --> KB_BE : HTTP /api/*\n(JWT or API Key)

' Auth flow
KB_BE --> GoogleAuth : Validate OAuth token
KB_BE --> Redis : Rate limit checks\nSession cache

' Backend to DB
KB_BE --> Mongo : Async CRUD via Motor\n+ User/Auth operations

' Backend to LLM host
KB_BE --> Ollama : HTTP LLM chat / tools

@enduml
